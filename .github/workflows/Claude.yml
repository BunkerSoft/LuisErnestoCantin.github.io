name: Claude AI Assistant

on:
  issues:
    types: [opened, labeled, assigned]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, synchronize]
  pull_request_review_comment:
    types: [created]

jobs:
  claude-issue-response:
    if: |
      github.event_name == 'issues' && (
        contains(github.event.issue.labels.*.name, 'claude') ||
        contains(github.event.issue.labels.*.name, 'ai') ||
        contains(github.event.issue.body, '@claude')
      )
    
    runs-on: ubuntu-latest
    
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install @octokit/rest
      
      - name: Claude analyzes issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          node << 'ENDJS'
          const { Octokit } = require('@octokit/rest');
          const https = require('https');
          
          const octokit = new Octokit({ auth: process.env.GITHUB_TOKEN });
          
          function callClaude(prompt) {
            return new Promise((resolve, reject) => {
              const data = JSON.stringify({
                model: "claude-sonnet-4-5-20250929",
                max_tokens: 4000,
                messages: [{ role: "user", content: prompt }]
              });
              
              const options = {
                hostname: 'api.anthropic.com',
                port: 443,
                path: '/v1/messages',
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'x-api-key': process.env.ANTHROPIC_API_KEY,
                  'anthropic-version': '2023-06-01',
                  'Content-Length': data.length
                }
              };
              
              const req = https.request(options, (res) => {
                let body = '';
                res.on('data', (chunk) => { body += chunk; });
                res.on('end', () => {
                  try {
                    const response = JSON.parse(body);
                    if (response.content && response.content[0]) {
                      resolve(response.content[0].text);
                    } else if (response.error) {
                      reject(new Error(response.error.message || 'API Error'));
                    } else {
                      reject(new Error('Invalid response'));
                    }
                  } catch (err) { reject(err); }
                });
              });
              req.on('error', reject);
              req.write(data);
              req.end();
            });
          }
          
          async function main() {
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            const issueTitle = process.env.ISSUE_TITLE;
            const issueBody = process.env.ISSUE_BODY || '';
            const issueAuthor = process.env.ISSUE_AUTHOR;
            
            console.log('Claude procesando Issue #' + issueNumber);
            
            try {
              const prompt = "Eres Claude, asistente AI del repo BunkerSoft/LuisErnestoCantin.github.io\n\n" +
                "Portfolio en GitHub Pages (HTML5, CSS3, JS vanilla)\n\n" +
                "Issue #" + issueNumber + "\n" +
                "Autor: @" + issueAuthor + "\n" +
                "Título: " + issueTitle + "\n\n" +
                "Descripción:\n" + issueBody + "\n\n" +
                "Restricciones: GitHub Pages, sin frameworks, responsive\n\n" +
                "Tareas:\n" +
                "1. Analiza viabilidad\n" +
                "2. Plan paso a paso\n" +
                "3. Código específico\n" +
                "4. Archivos a modificar\n" +
                "5. Estimación\n\n" +
                "Responde en Markdown con: Resumen, Viabilidad, Objetivos, Plan, Validación, Estimación";
              
              const response = await callClaude(prompt);
              
              await octokit.issues.createComment({
                owner: process.env.REPO_OWNER,
                repo: process.env.REPO_NAME,
                issue_number: issueNumber,
                body: response
              });
              
              const labels = ['claude-analyzed'];
              const combined = (issueTitle + ' ' + issueBody).toLowerCase();
              
              if (combined.includes('performance')) labels.push('performance');
              if (combined.includes('seo')) labels.push('seo');
              if (combined.includes('accessibility')) labels.push('accessibility');
              if (combined.includes('bug')) labels.push('bug');
              
              await octokit.issues.addLabels({
                owner: process.env.REPO_OWNER,
                repo: process.env.REPO_NAME,
                issue_number: issueNumber,
                labels: labels
              });
              
              console.log('Completado');
              
            } catch (error) {
              console.error('Error:', error.message);
              await octokit.issues.createComment({
                owner: process.env.REPO_OWNER,
                repo: process.env.REPO_NAME,
                issue_number: issueNumber,
                body: "Error: " + error.message
              });
              process.exit(1);
            }
          }
          
          main();
          ENDJS

  claude-implementation:
    if: |
      github.event_name == 'issue_comment' &&
      contains(github.event.comment.body, '/implement') &&
      contains(github.event.issue.labels.*.name, 'claude-analyzed')
    
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Configure Git
        run: |
          git config --global user.name "Claude AI Bot"
          git config --global user.email "claude@bunkersoft.dev"
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install @octokit/rest
      
      - name: Notify start
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          COMMENT_AUTHOR: ${{ github.event.comment.user.login }}
        run: |
          gh issue comment $ISSUE_NUMBER --body "Implementación iniciada @$COMMENT_AUTHOR"
      
      - name: Generate implementation
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          BRANCH_NAME="claude/issue-$ISSUE_NUMBER"
          git checkout -b "$BRANCH_NAME"
          
          node << 'ENDJS'
          const { Octokit } = require('@octokit/rest');
          const https = require('https');
          const fs = require('fs');
          const { execSync } = require('child_process');
          
          const octokit = new Octokit({ auth: process.env.GITHUB_TOKEN });
          
          function callClaude(prompt) {
            return new Promise((resolve, reject) => {
              const data = JSON.stringify({
                model: "claude-sonnet-4-5-20250929",
                max_tokens: 8000,
                messages: [{ role: "user", content: prompt }]
              });
              
              const options = {
                hostname: 'api.anthropic.com',
                port: 443,
                path: '/v1/messages',
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'x-api-key': process.env.ANTHROPIC_API_KEY,
                  'anthropic-version': '2023-06-01',
                  'Content-Length': data.length
                }
              };
              
              const req = https.request(options, (res) => {
                let body = '';
                res.on('data', (chunk) => { body += chunk; });
                res.on('end', () => {
                  try {
                    const response = JSON.parse(body);
                    if (response.content && response.content[0]) {
                      resolve(response.content[0].text);
                    } else {
                      reject(new Error('Invalid response'));
                    }
                  } catch (err) { reject(err); }
                });
              });
              req.on('error', reject);
              req.write(data);
              req.end();
            });
          }
          
          async function main() {
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            const issueTitle = process.env.ISSUE_TITLE;
            const issueBody = process.env.ISSUE_BODY || '';
            
            console.log('Generando código...');
            
            try {
              const files = {};
              const fileNames = ['index.html', 'style.css', 'script.js', 'README.md'];
              
              for (const file of fileNames) {
                if (fs.existsSync(file)) {
                  files[file] = fs.readFileSync(file, 'utf8');
                }
              }
              
              const filesText = Object.entries(files).map(([name, content]) => 
                name + ":\n" + content.substring(0, 2000)
              ).join('\n\n');
              
              const prompt = "Implementa solución para Issue #" + issueNumber + ": " + issueTitle + "\n\n" +
                issueBody + "\n\nArchivos actuales:\n" + filesText + "\n\n" +
                "Output JSON: {files: {filename: content}, new_files: {}, commit_message: '', pr_body: ''}";
              
              const response = await callClaude(prompt);
              const jsonMatch = response.match(/\{[\s\S]*\}/);
              if (!jsonMatch) throw new Error('No JSON found');
              
              const result = JSON.parse(jsonMatch[0]);
              
              for (const [filename, content] of Object.entries(result.files || {})) {
                fs.writeFileSync(filename, content, 'utf8');
                execSync('git add ' + filename);
                console.log('Modified: ' + filename);
              }
              
              for (const [filename, content] of Object.entries(result.new_files || {})) {
                fs.writeFileSync(filename, content, 'utf8');
                execSync('git add ' + filename);
                console.log('Created: ' + filename);
              }
              
              fs.writeFileSync('claude-metadata.json', JSON.stringify(result), 'utf8');
              
            } catch (error) {
              console.error('Error:', error.message);
              throw error;
            }
          }
          
          main();
          ENDJS
      
      - name: Commit and push
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          if [ -f claude-metadata.json ]; then
            COMMIT_MSG=$(node -e "console.log(JSON.parse(require('fs').readFileSync('claude-metadata.json', 'utf8')).commit_message || 'feat: implement issue')")
          else
            COMMIT_MSG="feat: implement issue #$ISSUE_NUMBER"
          fi
          
          git commit -m "$COMMIT_MSG" || echo "No changes"
          git push origin "claude/issue-$ISSUE_NUMBER"
      
      - name: Create PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          gh pr create \
            --title "Fix #$ISSUE_NUMBER: $ISSUE_TITLE" \
            --body "Closes #$ISSUE_NUMBER\n\nImplementación automática por Claude AI" \
            --base main \
            --head "claude/issue-$ISSUE_NUMBER" \
            --label "claude-generated,needs-review"
          
          PR_URL=$(gh pr view "claude/issue-$ISSUE_NUMBER" --json url -q .url)
          gh issue comment $ISSUE_NUMBER --body "PR creado: $PR_URL"

  claude-pr-review:
    if: |
      github.event_name == 'pull_request' && (
        contains(github.event.pull_request.body, '@claude') ||
        contains(github.event.pull_request.labels.*.name, 'claude-review')
      )
    
    runs-on: ubuntu-latest
    
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install @octokit/rest
      
      - name: Claude reviews PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          node << 'ENDJS'
          const { Octokit } = require('@octokit/rest');
          const https = require('https');
          
          const octokit = new Octokit({ auth: process.env.GITHUB_TOKEN });
          
          function callClaude(prompt) {
            return new Promise((resolve, reject) => {
              const data = JSON.stringify({
                model: "claude-sonnet-4-5-20250929",
                max_tokens: 4000,
                messages: [{ role: "user", content: prompt }]
              });
              
              const options = {
                hostname: 'api.anthropic.com',
                port: 443,
                path: '/v1/messages',
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'x-api-key': process.env.ANTHROPIC_API_KEY,
                  'anthropic-version': '2023-06-01',
                  'Content-Length': data.length
                }
              };
              
              const req = https.request(options, (res) => {
                let body = '';
                res.on('data', (chunk) => { body += chunk; });
                res.on('end', () => {
                  try {
                    const response = JSON.parse(body);
                    resolve(response.content[0].text);
                  } catch (err) { reject(err); }
                });
              });
              req.on('error', reject);
              req.write(data);
              req.end();
            });
          }
          
          async function main() {
            const prNumber = parseInt(process.env.PR_NUMBER);
            const prTitle = process.env.PR_TITLE;
            const prBody = process.env.PR_BODY || '';
            const prAuthor = process.env.PR_AUTHOR;
            
            console.log('Revisando PR #' + prNumber);
            
            try {
              const files = await octokit.pulls.listFiles({
                owner: process.env.REPO_OWNER,
                repo: process.env.REPO_NAME,
                pull_number: prNumber
              });
              
              const diffs = files.data.map(f => 
                f.filename + ': +' + f.additions + ' -' + f.deletions
              ).join('\n');
              
              const prompt = "Revisa PR #" + prNumber + ": " + prTitle + "\n" +
                "Autor: @" + prAuthor + "\n" +
                "Descripción: " + prBody + "\n\n" +
                "Cambios:\n" + diffs + "\n\n" +
                "Analiza: código, performance, SEO, accesibilidad\n" +
                "Responde: Resumen, Rating por categoría, Recomendación (APPROVE/COMMENT/REQUEST_CHANGES)";
              
              const review = await callClaude(prompt);
              
              let event = 'COMMENT';
              if (review.includes('APPROVE') && !review.includes('REQUEST_CHANGES')) {
                event = 'APPROVE';
              } else if (review.includes('REQUEST_CHANGES')) {
                event = 'REQUEST_CHANGES';
              }
              
              await octokit.pulls.createReview({
                owner: process.env.REPO_OWNER,
                repo: process.env.REPO_NAME,
                pull_number: prNumber,
                body: review,
                event: event
              });
              
              console.log('Review publicado: ' + event);
              
            } catch (error) {
              console.error('Error:', error.message);
              throw error;
            }
          }
          
          main();
          ENDJS
